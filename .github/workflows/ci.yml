name: Continuous Integration
on:
  pull_request:
  push:
    branches:
      - main
      - continuous_integration
    paths-ignore:
      - '**/README.md'
  schedule:
    - cron: '0 7 * * 1'
jobs:
  integrate:
    runs-on: ubuntu-20.04
    name: 'Integrate'
    services:
      mysql:
        image: docker://mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: magento
          MYSQL_DATABASE: magento
        ports:
          - 3303:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      elasticsearch:
        image: docker://magento/magento-cloud-docker-elasticsearch:7.9-1.3.0
        ports:
          - 9200:9200
        options: -e="discovery.type=single-node" --health-cmd="curl http://localhost:9200/_cluster/health" --health-interval=10s --health-timeout=5s --health-retries=3
    strategy:
      matrix:
        php-versions: ['7.4']
        magento-versions: ['2.4.3']
    env:
      magento-directory: /var/www/magento
      COMPOSER_MAGENTO_USERNAME: ${{ secrets.COMPOSER_MAGENTO_USERNAME }}
      COMPOSER_MAGENTO_PASSWORD: ${{ secrets.COMPOSER_MAGENTO_PASSWORD }}
    steps:
      - name: "[Init] Checkout repository"
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          persist-credentials: false

      - name: "[Init] Setup PHP"
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-versions }}
          extensions: hash, iconv, mbstring, intl, bcmath, ctype, gd, pdo, mysql, curl, zip, dom, sockets, soap, openssl, simplexml, xsl
          ini-values: post_max_size=256M, max_execution_time=180

      - name: "[Init] Add php-fpm"
        env:
          PHP_VERSION: ${{ matrix.php-versions }}
        run: |
          sudo apt install -y "php${PHP_VERSION}-fpm"
          sudo cp "/usr/sbin/php-fpm${PHP_VERSION} /usr/bin/php-fpm"
          sudo systemctl start "php${PHP_VERSION}-fpm"
          sudo systemctl status "php${PHP_VERSION}-fpm"

